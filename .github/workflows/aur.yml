name: Publish to AUR

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

jobs:
  aur:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-aur
        run: cargo install cargo-aur

      - name: Configure Git
        run: |
          git config --global user.name "MareDevi"
          git config --global user.email "me@maredevi.moe"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          echo "Host aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/aur
            StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Update AUR Package
        run: |
          APP_NAME=$(grep -m1 'name =' Cargo.toml | cut -d '"' -f 2)
          git clone "ssh://aur@aur.archlinux.org/${APP_NAME}.git" aur-repo
          cargo aur
          cp target/cargo-aur/PKGBUILD aur-repo/
          cd aur-repo
          makepkg --printsrcinfo > .SRCINFO
          if [ -n "$(git status --porcelain)" ]; then
            git add PKGBUILD .SRCINFO
            git commit -m "Update to ${{ github.event.workflow_run.head_branch }}"
            git push
            echo "ðŸš€ Successfully pushed to AUR!"
          else
            echo "No changes detected."
          fi
